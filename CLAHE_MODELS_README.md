# CLAHE-Enhanced Road Distress Classification Models

## 🎯 Overview

This system implements **Model E** and **Model F** for road distress classification with optimized CLAHE (Contrast Limited Adaptive Histogram Equalization) enhancement:

- **Model E**: CLAHE + Full Mask Overlay (1.0 opacity)
- **Model F**: CLAHE + Half Mask Overlay (0.5 opacity)
- **No Data Augmentation** (as specified)
- **Per-Image Optimized CLAHE Parameters** from CSV lookup

## 🏗️ System Architecture

```
Raw Images → CLAHE Optimization → Parameter CSV → Training with Dynamic CLAHE
     ↓              ↓                   ↓                    ↓
  coryell/    batch_clahe_optimization  clahe_params.csv  Model E/F Training
```

### Key Components

1. **Batch CLAHE Optimizer**: Finds optimal parameters for each image
2. **CLAHE Dataset**: Applies optimized parameters during training
3. **Model E/F Trainers**: Complete training pipelines with different mask opacities

## 🚀 Quick Start

### Step 1: Optimize CLAHE Parameters

```bash
# Test with few images first
python batch_clahe_optimization.py \
    --dataset-dir coryell \
    --output-csv clahe_parameters.csv \
    --max-images 100

# Full dataset optimization (remove --max-images)
python batch_clahe_optimization.py \
    --dataset-dir coryell \
    --output-csv clahe_parameters.csv
```

**Output**: `clahe_parameters.csv` with optimal parameters for each image

### Step 2: Train Model E (Full Mask Overlay)

```bash
python train_model_e.py \
    --train-images data/train/images \
    --val-images data/val/images \
    --test-images data/test/images \
    --train-masks data/train/masks \
    --val-masks data/val/masks \
    --test-masks data/test/masks \
    --train-labels data/train_labels.csv \
    --val-labels data/val_labels.csv \
    --test-labels data/test_labels.csv \
    --clahe-params clahe_parameters.csv \
    --output-dir experiments/model_e \
    --batch-size 32 \
    --epochs 50
```

### Step 3: Train Model F (Half Mask Overlay)

```bash
python train_model_f.py \
    --train-images data/train/images \
    --val-images data/val/images \
    --test-images data/test/images \
    --train-masks data/train/masks \
    --val-masks data/val/masks \
    --test-masks data/test/masks \
    --train-labels data/train_labels.csv \
    --val-labels data/val_labels.csv \
    --test-labels data/test_labels.csv \
    --clahe-params clahe_parameters.csv \
    --output-dir experiments/model_f \
    --batch-size 32 \
    --epochs 50
```

## 📊 Model Specifications

### Model E Configuration
- **CLAHE Enhancement**: ✅ Per-image optimized parameters
- **Mask Overlay**: 1.0 opacity (full overlay)
- **Data Augmentation**: ❌ None
- **Architecture**: EfficientNet-B3 + Enhanced Classifier
- **Loss Function**: BCEWithLogitsLoss (multi-label)
- **Optimizer**: AdamW with OneCycleLR scheduler

### Model F Configuration
- **CLAHE Enhancement**: ✅ Per-image optimized parameters  
- **Mask Overlay**: 0.5 opacity (half overlay)
- **Data Augmentation**: ❌ None
- **Architecture**: EfficientNet-B3 + Enhanced Classifier
- **Loss Function**: BCEWithLogitsLoss (multi-label)
- **Optimizer**: AdamW with OneCycleLR scheduler

## 📁 Expected Directory Structure

```
your_project/
├── data/
│   ├── train/
│   │   ├── images/
│   │   └── masks/
│   ├── val/
│   │   ├── images/
│   │   └── masks/
│   └── test/
│       ├── images/
│       └── masks/
├── clahe_parameters.csv          # Generated by batch optimization
├── data/
│   ├── train_labels.csv         # Multi-label format
│   ├── val_labels.csv
│   └── test_labels.csv
└── experiments/
    ├── model_e/                 # Model E outputs
    └── model_f/                 # Model F outputs
```

## 📋 Data Format Requirements

### Labels CSV Format
```csv
image_name,damage,occlusion,crop
image001.png,1,0,0
image002.png,0,1,1
image003.png,1,1,0
```

### CLAHE Parameters CSV Format (Auto-generated)
```csv
image_path,clip_limit,tile_grid_x,tile_grid_y,composite_score
Co Rd 161/img/042_31.463257_-98.086842.png,8.0,16,16,3.2855
Co Rd 161/img/043_31.463406_-98.086960.png,5.0,12,12,2.8934
```

## 🔧 Configuration Options

### Batch CLAHE Optimization
```python
# Parameter ranges tested (configurable)
clip_limits = [1.0, 2.0, 3.0, 4.0, 5.0, 8.0]
tile_grid_sizes = [(4, 4), (8, 8), (12, 12), (16, 16)]

# Quality metrics weights
weights = {
    'edge_quality': 0.30,           # Edge detection for cracks
    'contrast_enhancement': 0.30,   # Shadow/lighting handling  
    'texture_preservation': 0.30,   # Road surface details
    'overall_quality': 0.10         # General image quality
}
```

### Training Parameters
```python
# Model Architecture
backbone = 'efficientnet-b3'  # or 'resnet50'
num_classes = 3  # damage, occlusion, crop

# Training Settings
batch_size = 32
learning_rate = 1e-3
weight_decay = 1e-4
epochs = 50
early_stopping_patience = 10

# Data Loading
img_size = 256
num_workers = 4
```

## 📈 Output & Results

### Training Outputs
```
experiments/model_e/
├── best_model.pth              # Best checkpoint
├── latest_checkpoint.pth       # Latest checkpoint  
├── training_summary.json       # Training metrics
└── tensorboard/                # TensorBoard logs

experiments/model_f/
├── best_model.pth
├── latest_checkpoint.pth
├── training_summary.json
└── tensorboard/
```

### Training Summary Example
```json
{
  "model_type": "Model E (CLAHE + Full Masks)",
  "best_val_accuracy": 0.8899,
  "total_epochs": 35,
  "final_train_loss": 0.2341,
  "final_val_loss": 0.3156,
  "training_completed": "2024-01-15T10:30:00"
}
```

## 🧪 Testing the System

Run the comprehensive test script:

```bash
python test_clahe_system.py --test-images-dir coryell --max-images 10
```

This will:
1. ✅ Test batch CLAHE optimization
2. ✅ Test CLAHE dataset creation  
3. ✅ Test data loading with different mask opacities
4. ✅ Generate usage examples
5. ✅ Verify the complete pipeline

## 💡 Key Features

### Dynamic CLAHE Application
- **Per-image optimization**: Each image gets its own optimal CLAHE parameters
- **CSV-based lookup**: No need to store enhanced images, apply on-the-fly
- **Memory efficient**: Only store parameters, not processed images

### Mask Integration
- **Variable opacity**: Compare full vs half mask overlay effects
- **Runtime application**: Masks applied during training, not preprocessing
- **Fallback handling**: Graceful handling of missing masks

### Robust Training
- **Multi-label classification**: Handle overlapping road conditions
- **Early stopping**: Prevent overfitting
- **Comprehensive metrics**: Per-class accuracy, precision, recall, F1
- **TensorBoard integration**: Visual training monitoring

## 🔍 Monitoring Training

### TensorBoard
```bash
tensorboard --logdir experiments/model_e/tensorboard
tensorboard --logdir experiments/model_f/tensorboard
```

### Key Metrics to Watch
- **Overall Validation Accuracy**: Primary metric
- **Per-class F1 Scores**: Damage, Occlusion, Crop performance
- **Training/Validation Loss**: Check for overfitting
- **Learning Rate Schedule**: OneCycleLR progression

## 🆚 Model Comparison

| Feature | Model E | Model F |
|---------|---------|---------|
| CLAHE Enhancement | ✅ Optimized | ✅ Optimized |
| Mask Overlay | 1.0 (Full) | 0.5 (Half) |
| Data Augmentation | ❌ | ❌ |
| Architecture | EfficientNet-B3 | EfficientNet-B3 |
| Use Case | Maximum mask guidance | Balanced mask/image info |

### When to Use Each Model
- **Model E**: When you have high-quality masks and want maximum mask guidance
- **Model F**: When you want to balance mask information with original image features

## 🛠️ Troubleshooting

### Common Issues

1. **Missing CLAHE parameters**: Dataset falls back to default (clip=3.0, grid=8x8)
2. **Missing masks**: System continues without mask overlay
3. **Memory issues**: Reduce batch_size or num_workers
4. **Slow optimization**: Use --max-images for testing first

### Performance Tips

1. **Fast optimization**: Use simplified metrics in `SimpleCLAHEOptimizer`
2. **Parallel processing**: Increase num_workers for data loading  
3. **GPU memory**: Monitor batch_size vs available VRAM
4. **Storage**: CLAHE parameters CSV is much smaller than enhanced images

## 📚 Dependencies

```bash
pip install torch torchvision opencv-python numpy pandas tqdm scikit-learn tensorboard segmentation-models-pytorch matplotlib
```

## 🎯 Expected Results

Based on your road distress classification task, expect:
- **Improved contrast** in shadowed/poor lighting conditions
- **Enhanced edge detection** for crack and damage identification  
- **Better texture preservation** for road surface analysis
- **Optimal parameters per image** rather than one-size-fits-all

The system automatically finds the best CLAHE settings for each image, maximizing road distress detection performance while maintaining image quality.

Perfect for drone road imagery where lighting conditions vary significantly across the dataset! 🛣️✨ 